name: Publish Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from (leave empty for default branch)'
        required: false
        default: ''
      sha:
        description: 'Commit SHA to release (leave empty for latest)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha || inputs.branch || '' }}

      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Download artifacts from build workflow
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build.yml
          workflow_conclusion: success
          branch: ${{ inputs.branch || '' }}
          commit: ${{ inputs.sha || '' }}
          path: artifacts

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.deb" -o -name "*.rpm" -o -name "*.flatpak" \) -exec cp {} release/ \;
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: release/*
          generate_release_notes: true
